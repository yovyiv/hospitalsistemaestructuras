#include <iostream>
#include <string>
#include <queue>
#include <stack>
#include <vector>
using namespace std;

/* ---------------------------------------------------
   Nodo del historial (lista)
--------------------------------------------------- */
class MedicalRecordNode {
public:
    string fecha;
    string nota;
    MedicalRecordNode* next;

    MedicalRecordNode(string f, string n) {
        fecha = f;
        nota = n;
        next = nullptr;
    }
};

/* ---------------------------------------------------
   Historial medico (pila usando lista enlazada)
--------------------------------------------------- */
class HistorialPila {
private:
    MedicalRecordNode* head;

public:
    HistorialPila() { head = nullptr; }

    void push(string fecha, string nota) {
        MedicalRecordNode* nuevo = new MedicalRecordNode(fecha, nota);
        nuevo->next = head;
        head = nuevo;
    }

    void pop() {
        if (!head) return;
        MedicalRecordNode* temp = head;
        head = head->next;
        delete temp;
    }

    void mostrar() const {
        if (!head) {
            cout << "  (sin historial)\n";
            return;
        }

        MedicalRecordNode* aux = head;
        while (aux) {
            cout << "   - " << aux->fecha << ": " << aux->nota << "\n";
            aux = aux->next;
        }
    }
};

/* ---------------------------------------------------
   Clase Paciente
--------------------------------------------------- */
class Paciente {
public:
    int id;
    string nombre;
    int edad;
    string condicion;
    int piso;
    int habitacion;
    HistorialPila historial;

    Paciente(int i, string n, int e, string c)
        : id(i), nombre(n), edad(e), condicion(c),
          piso(0), habitacion(0) {}

    void mostrar() {
        cout << "Paciente #" << id << " - " << nombre
             << " (" << edad << " años) Condicion: " << condicion << "\n";
        if (piso >= 0)
            cout << "  Ubicacion: Piso " << piso << ", Hab " << habitacion << "\n";
        else
            cout << "  Ubicacion: No asignada\n";

        cout << "  Historial:\n";
        historial.mostrar();
    }
};

/* ---------------------------------------------------
   Habitacion
--------------------------------------------------- */
class Habitacion {
public:
    bool ocupada;
    int pacienteID;

    Habitacion() {
        ocupada = false;
        pacienteID = -1;
    }
};

/* ---------------------------------------------------
   Clase Hospital (usa MATRIZ)
--------------------------------------------------- */
class Hospital {
private:
    vector<Paciente*> pacientes;

    //MATRIZ de habitaciones: pisos × habitaciones
    vector<vector<Habitacion>> matrizHab;

    queue<Paciente*> cola;
    stack<string> acciones;

public:
    Hospital(int pisos, int habXpisos) {
        matrizHab.resize(pisos, vector<Habitacion>(habXpisos));
    }

    /* -----------------------------------------
       Registrar Paciente
    ----------------------------------------- */
    void registrarPaciente(int id, string nombre, int edad, string condicion) {
        pacientes.push_back(new Paciente(id, nombre, edad, condicion));
        acciones.push("Registro de paciente");
        cout << "Paciente registrado correctamente.\n";
    }

    Paciente* buscar(int id) {
        for (auto p : pacientes)
            if (p->id == id) return p;
        return nullptr;
    }

    /* -----------------------------------------
       Asignar a habitación (MATRIZ)
    ----------------------------------------- */
    void asignarHabitacion(int id) {
        Paciente* p = buscar(id);
        if (!p) {
            cout << "Paciente no encontrado.\n";
            return;
        }

        for (int i = 1; i < matrizHab.size(); i++) {
            for (int j = 1; j < matrizHab[i].size(); j++) {
                if (!matrizHab[i][j].ocupada) {
                    matrizHab[i][j].ocupada = true;
                    matrizHab[i][j].pacienteID = id;

                    p->piso = i;
                    p->habitacion = j;

                    acciones.push("Asignación de habitación");

                    cout << "Asignado a Piso " << i << ", Habitación " << j << "\n";
                    return;
                }
            }
        }

        cout << "No hay habitaciones disponibles.\n";
    }

    /* -----------------------------------------
       Liberar habitacion
    ----------------------------------------- */
    void liberarHabitacion(int id) {
        Paciente* p = buscar(id);
        if (!p || p->piso < 0) {
            cout << "El paciente no tiene habitacion.\n";
            return;
        }

        matrizHab[p->piso][p->habitacion].ocupada = false;
        matrizHab[p->piso][p->habitacion].pacienteID = -1;

        p->piso = 0;
        p->habitacion = 0;

        acciones.push("Liberación de habitacion");

        cout << "Habitacion liberada.\n";
    }

    /* -----------------------------------------
       Cola de turnos
    ----------------------------------------- */
    void agregarATurno(int id) {
        Paciente* p = buscar(id);
        if (!p) {
            cout << "Paciente no encontrado.\n";
            return;
        }
        cola.push(p);
        acciones.push("Agregar a turno");
        cout << "Paciente añadido a la cola.\n";
    }

    void atenderTurno() {
        if (cola.empty()) {
            cout << "No hay pacientes en cola.\n";
            return;
        }

        Paciente* p = cola.front();
        cola.pop();

        acciones.push("Atender turno");

        cout << "Atendiendo a: " << p->nombre << "\n";
    }

    /* -----------------------------------------
       Historial
    ----------------------------------------- */
    void agregarHistorial(int id, string fecha, string nota) {
        Paciente* p = buscar(id);
        if (!p) {
            cout << "Paciente no encontrado.\n";
            return;
        }

        p->historial.push(fecha, nota);
        acciones.push("Agregar historial");

        cout << "Historial añadido.\n";
    }

    /* -----------------------------------------
       DESHACER
    ----------------------------------------- */
    void deshacer() {
        if (acciones.empty()) {
            cout << "Nada para deshacer.\n";
            return;
        }

        cout << "Deshaciendo: " << acciones.top() << "\n";
        acciones.pop();
    }

    /* -----------------------------------------
       Mostrar datos
    ----------------------------------------- */
    void mostrarDatos() {
        cout << "\n=== PACIENTES ===\n";
        for (auto p : pacientes) {
            p->mostrar();
            cout << "\n";
        }

        cout << "\n=== MATRIZ DE HABITACIONES ===\n";
        for (int i = 1; i < matrizHab.size(); i++) {
            cout << "Piso " << i << ": ";
            for (int j = 1; j < matrizHab[i].size(); j++) {
                cout << (matrizHab[i][j].ocupada ? "[X] " : "[ ] ");
            }
            cout << "\n";
        }

        cout << "\nEn cola: " << cola.size() << " pacientes\n";
        cout << "Acciones por deshacer: " << acciones.size() << "\n";
    }
};

/* ---------------------------------------------------
   MAIN CON MENu COMPLETO
--------------------------------------------------- */

int main() {
    Hospital h(3, 4); // 2 pisos 3 habitaciones
    int op;

    while (true) {
        cout << "\n--- MENU ---\n"
             << "1 Registrar paciente\n"
             << "2 Asignar habitacion\n"
             << "3 Agregar Historial\n"
             << "4 Agregar a cola\n"
             << "5 Atender turno\n"
             << "6 Liberar habitacion\n"
             << "7 Ver historial paciente\n"
             << "8 Ver datos del hospital\n"
             << "9 Deshacer ultima acción\n"
            // << "0 Salir\n"
             << "Opción: ";
        cin >> op;

      //  if (op == 0) break;

        int id, edad;
        string nombre, cond, fecha, nota;

        switch (op) {
        case 1:
            cout << "ID: ";
            cin >> id;
            cin.ignore();  
            cout << "Nombre: ";
            getline(cin, nombre);
            cout << "Edad: ";
            cin >> edad;
            cin.ignore();  
            cout << "Condicion: ";
            getline(cin, cond);
    
            h.registrarPaciente(id, nombre, edad, cond);
            break;
    
        case 2:
            cout << "ID: "; cin >> id;
            h.asignarHabitacion(id);
            break;

        case 3:
            cout << "ID: "; cin >> id;
            cout << "Fecha: ";
            cin >> fecha;
            cin.ignore();
            cout << "Nota: ";
            getline(cin, nota);
            h.agregarHistorial(id, fecha, nota);
            
            break;

        case 4:
            cout << "ID: "; cin >> id;
            h.agregarATurno(id);
            break;

        case 5:
            h.atenderTurno();
            break;

        case 6:
            cout << "ID: "; cin >> id;
            h.liberarHabitacion(id);
            break;

        case 7:
            cout << "ID: "; cin >> id;
            if (Paciente* p = h.buscar(id))
                p->mostrar();
            else
                cout << "No encontrado.\n";
            break;

        case 8:
            h.mostrarDatos();
            break;

        case 9:
            h.deshacer();
            break;
        }
    }

    return 0;
}
